---
import Layout from "../layouts/Layout.astro";
import { loadItems } from "../lib/items";

type ListItem = {
  id: string;
  name: string;
  description: string;
  assetGuid?: number | null;
  source?: string | null;
};

type GroupNode = {
  segment: string;
  label: string;
  path: string[];
  children: Map<string, GroupNode>;
  items: ListItem[];
};

const items = loadItems();
const listItems: ListItem[] = items
  .map((item) => ({
    id: item.id,
    name: item.name ?? item.id,
    description: item.description ?? "",
    assetGuid: item.asset_guid ?? null,
    source: item.sources?.[0] ?? null,
  }))
  .sort((a, b) => a.name.localeCompare(b.name));

const formatGroupSegment = (segment: string) => {
  const withSpaces = segment
    .replaceAll("_", " ")
    .replaceAll("-", " ")
    .replace(/([a-z])([A-Z])/g, "$1 $2")
    .replace(/(\d)([a-zA-Z])/g, "$1 $2");

  return withSpaces
    .split(" ")
    .filter(Boolean)
    .map((word) => {
      if (/^\d+$/.test(word)) return word;
      if (word.length <= 1) return word.toUpperCase();
      return word[0].toUpperCase() + word.slice(1);
    })
    .join(" ");
};

const splitItemId = (id: string) => {
  const segments = id.split(".").filter(Boolean);
  if (segments[0] === "items") segments.shift();
  if (segments.length <= 1) return { groups: [], leaf: segments[0] ?? "" };
  return { groups: segments.slice(0, -1), leaf: segments.at(-1) ?? "" };
};

const rootGroup: GroupNode = {
  segment: "",
  label: "",
  path: [],
  children: new Map(),
  items: [],
};

for (const item of listItems) {
  const { groups } = splitItemId(item.id);
  let node = rootGroup;
  for (const segment of groups) {
    let next = node.children.get(segment);
    if (!next) {
      next = {
        segment,
        label: formatGroupSegment(segment),
        path: [...node.path, segment],
        children: new Map(),
        items: [],
      };
      node.children.set(segment, next);
    }
    node = next;
  }
  node.items.push(item);
}

const countGroupItems = (node: GroupNode): number => {
  let total = node.items.length;
  for (const child of node.children.values()) {
    total += countGroupItems(child);
  }
  return total;
};

const getSortedChildren = (node: GroupNode): GroupNode[] =>
  [...node.children.values()].sort((a, b) => a.label.localeCompare(b.label));

const toGroupDomId = (segments: string[]) =>
  ["group", ...segments]
    .join("-")
    .replace(/[^a-zA-Z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "")
    .toLowerCase();

const escapeHtml = (value: string) =>
  value
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");

const pluralize = (count: number, singular: string, plural = `${singular}s`) =>
  count === 1 ? singular : plural;

const getCountLabel = (node: GroupNode) => {
  const childCount = node.children.size;
  const totalItems = countGroupItems(node);
  if (childCount > 0) {
    return `${childCount} ${pluralize(childCount, "group")} · ${totalItems} ${pluralize(totalItems, "item")}`;
  }
  return `${node.items.length} ${pluralize(node.items.length, "item")}`;
};

const renderGroupSummary = (level: number, id: string, label: string, countLabel: string) => {
  const paddingClass = level === 0 ? "p-4" : "p-3";
  const labelClassName =
    level === 0
      ? "text-lg font-semibold text-white"
      : level === 1
        ? "text-base font-semibold text-slate-100"
        : level === 2
          ? "text-sm font-semibold text-slate-200"
          : "text-sm font-medium text-slate-300";
  const iconClassName = level === 0 ? "h-5 w-5" : "h-4 w-4";

  return [
    `<summary id="${escapeHtml(id)}" class="flex cursor-pointer select-none items-center gap-2 ${paddingClass} hover:bg-white/5">`,
    `  <svg class="${iconClassName} items-chevron shrink-0 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">`,
    '    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>',
    "  </svg>",
    `  <span class="${labelClassName}">${escapeHtml(label)}</span>`,
    `  <span class="ml-auto text-xs text-slate-400">${escapeHtml(countLabel)}</span>`,
    "</summary>",
  ].join("");
};

const renderItemCard = (item: ListItem) => {
  const href = `/items/${encodeURIComponent(item.id)}`;
  const description = item.description || "No description yet.";

  const idPill = item.assetGuid
    ? `<span class="shrink-0 rounded bg-white/5 px-2 py-1 text-xs text-slate-300">ID: ${item.assetGuid}</span>`
    : "";

  const sourceLine = item.source
    ? [
        '<div class="mt-3 flex items-center gap-2 text-xs text-slate-400">',
        '  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">',
        '    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>',
        "  </svg>",
        `  <span class="truncate">${escapeHtml(item.source)}</span>`,
        "</div>",
      ].join("")
    : "";

  return [
    `<a class="block rounded-xl border border-slate-800 bg-gradient-to-r from-slate-950/40 to-slate-900/40 p-4 transition hover:border-slate-600" href="${escapeHtml(href)}">`,
    '  <div class="flex items-start justify-between gap-3">',
    `    <h3 class="font-semibold text-white">${escapeHtml(item.name)}</h3>`,
    `    ${idPill}`,
    "  </div>",
    `  <p class="mt-2 text-sm leading-relaxed text-slate-300">${escapeHtml(description)}</p>`,
    `  ${sourceLine}`,
    `  <div class="mt-3 text-xs text-slate-400"><code class="rounded bg-white/5 px-2 py-1">${escapeHtml(item.id)}</code></div>`,
    "</a>",
  ]
    .filter(Boolean)
    .join("");
};

const renderItemList = (items: ListItem[]) => {
  const cards = items.map(renderItemCard).join("");
  return `<div class="space-y-3 py-2">${cards}</div>`;
};

const renderGroupSection = (node: GroupNode, level: number): string => {
  const children = getSortedChildren(node);
  const items = [...node.items].sort((a, b) => a.name.localeCompare(b.name));
  const headingId = toGroupDomId(node.path);

  const childrenHtml = children.map((child) => renderGroupSection(child, level + 1)).join("");
  const itemsHtml = items.length ? renderItemList(items) : "";

  let contentHtml = "";

  if (children.length) {
    const blocks: string[] = [];
    if (childrenHtml) blocks.push(childrenHtml);
    if (itemsHtml) {
      blocks.push(`<div class="pl-6 ml-6">${itemsHtml}</div>`);
    }
    contentHtml = `<div class="ml-6 space-y-1 border-l-2 border-slate-800 pl-6">${blocks.join("")}</div>`;
  } else if (itemsHtml) {
    contentHtml = `<div class="ml-6 pl-6">${itemsHtml}</div>`;
  }

  return [
    `<details class="group" data-group aria-labelledby="${escapeHtml(headingId)}">`,
    renderGroupSummary(level, headingId, node.label, getCountLabel(node)),
    contentHtml,
    "</details>",
  ].join("");
};

const groupedHtml = (() => {
  const rootChildrenCount = rootGroup.children.size + (rootGroup.items.length ? 1 : 0);
  const rootCountLabel = `${rootChildrenCount} ${pluralize(rootChildrenCount, "group")} · ${listItems.length} ${pluralize(listItems.length, "item")}`;

  const childBlocks: string[] = [];

  if (rootGroup.items.length) {
    const ungroupedNode: GroupNode = {
      segment: "ungrouped",
      label: "Ungrouped",
      path: ["ungrouped"],
      children: new Map(),
      items: [...rootGroup.items],
    };
    childBlocks.push(renderGroupSection(ungroupedNode, 1));
  }

  for (const child of getSortedChildren(rootGroup)) {
    childBlocks.push(renderGroupSection(child, 1));
  }

  const contentHtml = childBlocks.length
    ? `<div class="ml-6 space-y-1 border-l-2 border-slate-800 pl-6 py-2">${childBlocks.join("")}</div>`
    : '<div class="p-4 text-sm text-slate-500">No items found.</div>';

  return [
    '<div class="overflow-hidden rounded-2xl border border-slate-800 bg-slate-900/60">',
    '<details class="group" open aria-labelledby="group-items">',
    renderGroupSummary(0, "group-items", "Items", rootCountLabel),
    contentHtml,
    "</details>",
    "</div>",
  ].join("");
})();
---

<Layout title="Items | No Rest For The Wicked Wiki" description="Browse all items and refinement paths.">
  <main class="mx-auto flex min-h-screen max-w-5xl flex-col gap-10 px-6 py-16">
    <header class="space-y-4">
      <p class="text-sm uppercase tracking-[0.35em] text-slate-400">Item database</p>
      <h1 class="text-4xl font-semibold text-white md:text-6xl">Items</h1>
      <p class="max-w-2xl text-lg text-slate-300">
        Search every item by name, ID, or description. Click an entry to see its
        refinement tree and details.
      </p>
    </header>

    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
      <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
        <div class="space-y-2">
          <label class="text-sm font-semibold text-slate-200" for="item-search">
            Search items
          </label>
          <input
            id="item-search"
            class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-4 py-3 text-base text-slate-100 placeholder:text-slate-500 focus:border-slate-400 focus:outline-none md:w-[420px]"
            placeholder="Try “plagueflask”, “pine planks”, or “items.projectiles”"
          />
        </div>
        <div class="flex flex-wrap items-center gap-3 text-sm">
          <button
            id="toggle-groups"
            type="button"
            class="rounded-xl border border-slate-700 bg-slate-950/70 px-4 py-2 font-semibold text-slate-200 transition hover:border-slate-500 hover:text-white"
          >
            Expand all
          </button>
          <div class="text-slate-400">
            <span id="item-count">{listItems.length}</span> items
          </div>
        </div>
      </div>
    </section>

    <section>
      <script type="application/json" id="items-data" set:html={JSON.stringify(listItems)}></script>
      <div id="items-grid" class="space-y-10" aria-live="polite" set:html={groupedHtml} />
    </section>
  </main>

  <script type="module" src="/scripts/item-search.js"></script>

  <style>
    #items-grid summary {
      list-style: none;
    }

    #items-grid summary::-webkit-details-marker {
      display: none;
    }

    #items-grid summary::marker {
      content: "";
    }

    #items-grid .items-chevron {
      transition: transform 160ms ease;
      transform-origin: center;
    }

    #items-grid details[open] > summary .items-chevron {
      transform: rotate(90deg);
    }
  </style>
</Layout>
