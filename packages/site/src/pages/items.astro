---
import Layout from "../layouts/Layout.astro";
import { loadItems } from "../lib/items";

type ListItem = { id: string; name: string; description: string };

type GroupNode = {
  segment: string;
  label: string;
  path: string[];
  children: Map<string, GroupNode>;
  items: ListItem[];
};

const items = loadItems();
const listItems: ListItem[] = items
  .map((item) => ({
    id: item.id,
    name: item.name ?? item.id,
    description: item.description ?? "",
  }))
  .sort((a, b) => a.name.localeCompare(b.name));

const formatGroupSegment = (segment: string) => {
  const withSpaces = segment
    .replaceAll("_", " ")
    .replaceAll("-", " ")
    .replace(/([a-z])([A-Z])/g, "$1 $2")
    .replace(/(\d)([a-zA-Z])/g, "$1 $2");

  return withSpaces
    .split(" ")
    .filter(Boolean)
    .map((word) => {
      if (/^\d+$/.test(word)) return word;
      if (word.length <= 1) return word.toUpperCase();
      return word[0].toUpperCase() + word.slice(1);
    })
    .join(" ");
};

const splitItemId = (id: string) => {
  const segments = id.split(".").filter(Boolean);
  if (segments[0] === "items") segments.shift();
  if (segments.length <= 1) return { groups: [], leaf: segments[0] ?? "" };
  return { groups: segments.slice(0, -1), leaf: segments.at(-1) ?? "" };
};

const rootGroup: GroupNode = {
  segment: "",
  label: "",
  path: [],
  children: new Map(),
  items: [],
};

for (const item of listItems) {
  const { groups } = splitItemId(item.id);
  let node = rootGroup;
  for (const segment of groups) {
    let next = node.children.get(segment);
    if (!next) {
      next = {
        segment,
        label: formatGroupSegment(segment),
        path: [...node.path, segment],
        children: new Map(),
        items: [],
      };
      node.children.set(segment, next);
    }
    node = next;
  }
  node.items.push(item);
}

const countGroupItems = (node: GroupNode): number => {
  let total = node.items.length;
  for (const child of node.children.values()) {
    total += countGroupItems(child);
  }
  return total;
};

const getSortedChildren = (node: GroupNode): GroupNode[] =>
  [...node.children.values()].sort((a, b) => a.label.localeCompare(b.label));

const toGroupDomId = (segments: string[]) =>
  ["group", ...segments]
    .join("-")
    .replace(/[^a-zA-Z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "")
    .toLowerCase();

const escapeHtml = (value: string) =>
  value
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");

const renderSummary = (level: number, id: string, label: string, totalCount: number) => {
  const labelClassName =
    level === 0
      ? "text-xl font-semibold text-white md:text-2xl"
      : level === 1
        ? "text-lg font-semibold text-white"
        : level === 2
          ? "text-base font-semibold text-white"
          : "text-sm font-semibold text-white";

  return [
    `<summary id="${escapeHtml(id)}" class="cursor-pointer select-none p-5 [&::-webkit-details-marker]:hidden">`,
    '  <div class="flex items-center justify-between gap-3">',
    `    <span class="${labelClassName}">${escapeHtml(label)}</span>`,
    `    <span class="rounded-full bg-white/10 px-2 py-1 text-xs text-slate-200">${totalCount}</span>`,
    "  </div>",
    "</summary>",
  ].join("");
};

const renderItemCard = (item: ListItem) => {
  const href = `/items/${encodeURIComponent(item.id)}`;
  return [
    `<a class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 transition hover:border-slate-600" href="${escapeHtml(href)}">`,
    `  <h3 class="text-lg font-semibold text-white">${escapeHtml(item.name)}</h3>`,
    `  <p class="mt-1 text-xs text-slate-400">${escapeHtml(item.id)}</p>`,
    `  <p class="mt-3 text-sm text-slate-300">${escapeHtml(item.description || "No description yet.")}</p>`,
    "</a>",
  ].join("");
};

const renderItemsGrid = (items: ListItem[]) => {
  const cards = items.map(renderItemCard).join("");
  return `<div class="grid gap-4 md:grid-cols-2">${cards}</div>`;
};

const renderGroupSection = (node: GroupNode, level: number): string => {
  const children = getSortedChildren(node);
  const items = [...node.items].sort((a, b) => a.name.localeCompare(b.name));
  const totalCount = countGroupItems(node);
  const headingId = toGroupDomId(node.path);

  const itemsHtml = items.length ? renderItemsGrid(items) : "";
  const childHtml = children.length
    ? `<div class="space-y-8 border-l border-slate-800 pl-5">${children
        .map((child) => renderGroupSection(child, level + 1))
        .join("")}</div>`
    : "";

  const contentBlocks = [itemsHtml, childHtml].filter(Boolean).join("");
  const contentHtml = contentBlocks
    ? `<div class="px-5 pb-5 space-y-8">${contentBlocks}</div>`
    : "";

  return [
    `<details class="rounded-2xl border border-slate-800 bg-slate-900/60 transition hover:border-slate-600" data-group aria-labelledby="${escapeHtml(headingId)}">`,
    renderSummary(level, headingId, node.label, totalCount),
    contentHtml,
    "</details>",
  ].join("");
};

const groupedHtml = (() => {
  const blocks: string[] = [];

  if (rootGroup.items.length) {
    const items = [...rootGroup.items].sort((a, b) => a.name.localeCompare(b.name));
    blocks.push(
      [
        '<details class="rounded-2xl border border-slate-800 bg-slate-900/60 transition hover:border-slate-600" data-group aria-labelledby="group-ungrouped">',
        renderSummary(0, "group-ungrouped", "Ungrouped", rootGroup.items.length),
        `<div class="px-5 pb-5 space-y-8">${renderItemsGrid(items)}</div>`,
        "</details>",
      ].join("")
    );
  }

  for (const child of getSortedChildren(rootGroup)) {
    blocks.push(renderGroupSection(child, 0));
  }

  return blocks.join("");
})();
---

<Layout title="Items | No Rest For The Wicked Wiki" description="Browse all items and refinement paths.">
  <main class="mx-auto flex min-h-screen max-w-5xl flex-col gap-10 px-6 py-16">
    <header class="space-y-4">
      <p class="text-sm uppercase tracking-[0.35em] text-slate-400">Item database</p>
      <h1 class="text-4xl font-semibold text-white md:text-6xl">Items</h1>
      <p class="max-w-2xl text-lg text-slate-300">
        Search every item by name, ID, or description. Click an entry to see its
        refinement tree and details.
      </p>
    </header>

    <section class="rounded-2xl border border-slate-800 bg-slate-900/60 p-6">
      <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
        <div class="space-y-2">
          <label class="text-sm font-semibold text-slate-200" for="item-search">
            Search items
          </label>
          <input
            id="item-search"
            class="w-full rounded-xl border border-slate-700 bg-slate-950/70 px-4 py-3 text-base text-slate-100 placeholder:text-slate-500 focus:border-slate-400 focus:outline-none md:w-[420px]"
            placeholder="Try “plagueflask”, “pine planks”, or “items.projectiles”"
          />
        </div>
        <div class="flex flex-wrap items-center gap-3 text-sm">
          <button
            id="toggle-groups"
            type="button"
            class="rounded-xl border border-slate-700 bg-slate-950/70 px-4 py-2 font-semibold text-slate-200 transition hover:border-slate-500 hover:text-white"
          >
            Expand all
          </button>
          <div class="text-slate-400">
            <span id="item-count">{listItems.length}</span> items
          </div>
        </div>
      </div>
    </section>

    <section>
      <script type="application/json" id="items-data" set:html={JSON.stringify(listItems)}></script>
      <div id="items-grid" class="space-y-10" aria-live="polite" set:html={groupedHtml} />
    </section>
  </main>

  <script type="module" src="/scripts/item-search.js"></script>

</Layout>
